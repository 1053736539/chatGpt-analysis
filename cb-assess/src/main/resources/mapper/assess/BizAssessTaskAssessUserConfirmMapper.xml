<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cb.assess.mapper.BizAssessTaskAssessUserConfirmMapper">
    
    <resultMap type="BizAssessTaskAssessUserConfirm" id="BizAssessTaskAssessUserConfirmResult">
        <result property="id" column="id"/>
        <result property="taskId"    column="task_id"    />
        <result property="deptId"    column="dept_id"    />
        <result property="usersJson"    column="users_json"    />
        <result property="status"    column="status"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="remark"    column="remark"    />
    </resultMap>

    <resultMap type="VOrdinaryAssessTask" id="VOrdinaryAssessTaskResult">
        <result property="taskId" column="task_id"/>
        <result property="taskName" column="task_name"/>
        <result property="proId" column="pro_id"/>
        <result property="proName" column="pro_name"/>
        <result property="cycle" column="cycle"/>
        <result property="cycleDesc" column="cycle_desc"/>
        <result property="belongYear" column="belong_year"/>
        <result property="special" column="special"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="type" column="type"/>
        <result property="taskStatus" column="task_status"/>
        <result property="processStatus" column="process_status"/>
    </resultMap>
    <sql id="selectBizAssessTaskAssessUserConfirmVo">
        select id, task_id, dept_id, users_json, status, create_by, create_time, update_by, update_time, remark,rejection from biz_assess_task_assess_user_confirm
    </sql>



    <select id="selectTaskManageNeedConfirmList" resultMap="VOrdinaryAssessTaskResult">
        select T.* from(
            SELECT
            a.task_id,
            a.task_name,
            a.cycle,
            a.belong_year,
            a.special,
            a.type,
            a.cycle_desc,
            a.task_status,
            a.start_time,
            a.end_time,
            a.del_flag,
            a.create_time,
            a.pro_id,
            a.pro_name,
            a.score,
            pd.dept_id as assess_dept_id,
            case when cf.status is null then 0 else cf.status end  as process_status
            FROM
            v_ordinary_assess_task a
            left join biz_assess_indicator_pro_duty pd ON pd.pro_id = a.pro_id
            left join biz_assess_task_assess_user_confirm cf on cf.task_id = a.task_id and cf.dept_id = pd.dept_id
        ) as T
        <where>
            and T.special ='0'  and T.del_flag = '1' and T.assess_dept_id = #{deptId}
            <if test="et.taskId != null  and et.taskId != ''"> and T.task_id =#{taskId}</if>
            <if test="et.taskName != null  and et.taskName != ''"> and T.task_name like concat('%', #{et.taskName}, '%')</if>
            <if test="et.belongYear != null  and et.belongYear != ''"> and T.belong_year = #{et.belongYear}</if>
            <if test="et.cycleDesc != null  and et.cycleDesc != ''"> and T.cycle_desc = #{et.cycleDesc}</if>
            <if test="et.processStatus != null  and et.processStatus != ''">
                <choose>
                    <when test="et.processStatus == '0'.toString()">
                        and T.process_status in('0','2')
                        and T.task_status = '0'
                    </when>
                    <otherwise>
                        and T.process_status in('1','3')
                        and T.task_status in('0','1','2')
                    </otherwise>
                </choose>
            </if>
        </where>
        order by T.create_time desc
    </select>

    <select id="selectTaskAssessUserConfirm" resultMap="BizAssessTaskAssessUserConfirmResult">
        <include refid="selectBizAssessTaskAssessUserConfirmVo"/>
        where task_id = #{taskId} and dept_id = #{deptId}
    </select>
    <select id="selectTaskAssessUserConfirmByTaskId" resultMap="BizAssessTaskAssessUserConfirmResult">
        <include refid="selectBizAssessTaskAssessUserConfirmVo"/>
        where task_id = #{taskId}
    </select>
    <select id="selectConfirmUser" resultType="com.cb.assess.domain.vo.VTaskAssessConfirmUser">
        SELECT
            id,
            cf.task_id as taskId,
            cf.confirm_status as confirmStatus,
            cf.user_id as userId,
            cf.name as userName,
            cf.dept_id as deptId,
            cf.dept_name as deptName,
            t.cycle_desc as cycleDesc
        FROM
            v_task_assess_user_confirm cf
                join v_ordinary_assess_task as t on t.task_id = cf.task_id and cf.confirm_status = '1'
            where t.cycle_desc = #{cycleDesc}
              <if test="id != null and id != ''"> and cf.id != #{id}</if>
    </select>
    <insert id="insertBizAssessTaskAssessUserConfirm" parameterType="BizAssessTaskAssessUserConfirm">
        insert into biz_assess_task_assess_user_confirm
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null and id != ''">id,</if>
            <if test="taskId != null and taskId != ''">task_id,</if>
            <if test="deptId != null">dept_id,</if>
            <if test="usersJson != null">users_json,</if>
            <if test="status != null">status,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="remark != null">remark,</if>
            <if test="rejection != null">rejection,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null and id != ''">#{id},</if>
            <if test="taskId != null and taskId != ''">#{taskId},</if>
            <if test="deptId != null">#{deptId},</if>
            <if test="usersJson != null">#{usersJson},</if>
            <if test="status != null">#{status},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="remark != null">#{remark},</if>
            <if test="rejection != null">#{rejection},</if>
         </trim>
    </insert>

    <update id="updateBizAssessTaskAssessUserConfirm" parameterType="BizAssessTaskAssessUserConfirm">
        update biz_assess_task_assess_user_confirm
        <trim prefix="SET" suffixOverrides=",">
            <if test="usersJson != null">users_json = #{usersJson},</if>
            <if test="status != null">status = #{status},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="rejection != null">rejection = #{rejection},</if>
        </trim>
        where task_id = #{taskId} and dept_id =#{deptId}
    </update>

    <update id="updateBizAssessTaskAssessUserConfirmById" parameterType="BizAssessTaskAssessUserConfirm">
        update biz_assess_task_assess_user_confirm
        <trim prefix="SET" suffixOverrides=",">
            <if test="usersJson != null">users_json = #{usersJson},</if>
            <if test="status != null">status = #{status},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="rejection != null">rejection = #{rejection},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteBizAssessTaskAssessUserConfirmById" parameterType="String">
        delete from biz_assess_task_assess_user_confirm where task_id = #{taskId}
    </delete>

    <delete id="deleteBizAssessTaskAssessUserConfirmByIds" parameterType="String">
        delete from biz_assess_task_assess_user_confirm where task_id in 
        <foreach item="taskId" collection="array" open="(" separator="," close=")">
            #{taskId}
        </foreach>
    </delete>

    <select id="selectConfirmInfoById" resultMap="BizAssessTaskAssessUserConfirmResult">
        <include refid="selectBizAssessTaskAssessUserConfirmVo"></include>
        where id = #{id}
    </select>
</mapper>