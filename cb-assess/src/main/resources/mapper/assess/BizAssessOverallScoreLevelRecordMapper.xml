<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cb.assess.mapper.BizAssessOverallScoreLevelRecordMapper">

    <resultMap type="BizAssessOverallScoreLevelRecord" id="BizAssessOverallScoreLevelRecordResult">
        <result property="id" column="id"/>
        <result property="taskId" column="task_id"/>
        <result property="assessedUserId" column="assessed_user_id"/>
        <result property="userName" column="user_name"/>
        <result property="deptId" column="dept_id"/>
        <result property="deptName" column="dept_name"/>
        <result property="belongYear" column="belong_year"/>
        <result property="quarter" column="quarter"/>
        <result property="finalScore" column="final_score"/>
        <result property="finalOption" column="final_option"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="remark" column="remark"/>
        <result property="isFillRegular" column="is_fill_regular"/>
        <result property="cycle" column="cycle"/>
        <result property="cycleDesc" column="cycle_desc"/>
        <result property="personnelType" column="personnel_Type"/>
        <result property="special" column="special"/>
        <result property="taskName" column="task_name"/>
    </resultMap>

    <sql id="selectBizAssessOverallScoreLevelRecordVo">
        SELECT lr.id,
               lr.task_id,
               lr.assessed_user_id,
               lr.quarter,
               lr.final_score,
               lr.final_option,
               lr.create_by,
               lr.create_time,
               lr.update_by,
               lr.update_time,
               lr.remark,
               m.assess_cycle as cycle,
               CASE m.assess_cycle
                   WHEN '1' THEN m.task_moth
                   WHEN '2' THEN m.task_quarter
                   WHEN '3' THEN m.task_year
                   ELSE 'special' END as cycle_desc,
               m.task_name,
               p.personnel_type,
               m.special,
               m.belong_year,
               u.name as user_name,
               d.dept_id,
               d.dept_name,
               (select count(0)from  biz_assess_task_user_tag t join biz_assess_regular_info ri on ri.user_tag_id = t.id
                where t.user_id = lr.assessed_user_id and t.task_id = lr.task_id) as is_fill_regular
        FROM biz_assess_overall_score_level_record lr
                 join sys_user u on u.user_id = lr.assessed_user_id
                 join sys_dept d on d.dept_id = u.dept_id
                 join biz_assess_task_manage m on m.task_id = lr.task_id
                 join biz_assess_indicator_pro p on p.pro_id = m.pro_id
    </sql>

    <select id="selectBizAssessOverallScoreLevelRecordList" parameterType="BizAssessOverallScoreLevelRecord"
            resultMap="BizAssessOverallScoreLevelRecordResult">
        select * from (<include refid="selectBizAssessOverallScoreLevelRecordVo"/>) as T
        <where>
            <if test="belongYear != null  and belongYear != ''">and T.belong_year = #{belongYear}</if>
            <if test="quarter != null  and quarter != ''">and T.quarter = #{quarter}</if>
            <if test="assessedUserId != null">and T.assessed_user_id =#{assessedUserId} </if>
            <if test="deptId != null and deptId !=''">and T.dept_id = #{deptId}</if>
            <if test="finalOption != null and finalOption !=''">and T.final_option = #{finalOption}</if>
            <if test="special != null and special !=''">and T.special = #{special}</if>
        </where>
    </select>

    <select id="selectBizAssessOverallScoreLevelRecordById" parameterType="String"
            resultMap="BizAssessOverallScoreLevelRecordResult">
        <include refid="selectBizAssessOverallScoreLevelRecordVo"/>
        where id = #{id}
    </select>


    <insert id="insertBizAssessOverallScoreLevelRecord" parameterType="BizAssessOverallScoreLevelRecord">
        insert into biz_assess_overall_score_level_record
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null and id != ''">id,</if>
            <if test="taskId != null and taskId != ''">task_id,</if>
            <if test="assessedUserId != null">assessed_user_id,</if>
            <if test="quarter != null">quarter,</if>
            <if test="finalScore != null">final_score,</if>
            <if test="finalOption != null and finalOption != ''">final_option,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="remark != null">remark,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null and id != ''">#{id},</if>
            <if test="taskId != null and taskId != ''">#{taskId},</if>
            <if test="assessedUserId != null">#{assessedUserId},</if>
            <if test="quarter != null">#{quarter},</if>
            <if test="finalScore != null">#{finalScore},</if>
            <if test="finalOption != null and finalOption != ''">#{finalOption},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="remark != null">#{remark},</if>
        </trim>
    </insert>

    <update id="updateBizAssessOverallScoreLevelRecord" parameterType="BizAssessOverallScoreLevelRecord">
        update biz_assess_overall_score_level_record
        <trim prefix="SET" suffixOverrides=",">
            <if test="taskId != null and taskId != ''">task_id = #{taskId},</if>
            <if test="assessedUserId != null">assessed_user_id = #{assessedUserId},</if>
            <if test="quarter != null">quarter = #{quarter},</if>
            <if test="finalScore != null">final_score = #{finalScore},</if>
            <if test="finalOption != null and finalOption != ''">final_option = #{finalOption},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
        </trim>
        where id = #{id}
    </update>


    <delete id="deleteBizAssessOverallScoreLevelRecordById" parameterType="String">
        delete
        from biz_assess_overall_score_level_record
        where id = #{id}
    </delete>

    <delete id="deleteBizAssessOverallScoreLevelRecordByIds" parameterType="String">
        delete from biz_assess_overall_score_level_record where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="checkExist" resultType="java.lang.Boolean">
        select count(0)
        from biz_assess_overall_score_level_record
        where assessed_user_id = #{userId} and quarter = #{quarter}
        <if test="id != null and id != ''">and id != #{id}</if>
    </select>
    <select id="selectOneLevelRecord" resultType="com.cb.assess.domain.BizAssessOverallScoreLevelRecord">
        select * from (<include refid="selectBizAssessOverallScoreLevelRecordVo"/>) as T
        where t.assessed_user_id = #{userId} and T.quarter = #{quarter}
    </select>
    <select id="selectVEvaluationGradeAsLevelRecords" resultMap="BizAssessOverallScoreLevelRecordResult">
        SELECT
            task_id,
            user_id as assessed_user_id,
            cycle_desc as quarter,
            score as final_score,
            dzh_opinion as final_option
        FROM
            v_evaluation_grade
        <where>
            <if test="taskId != null and taskId != ''">and task_id=#{taskId}</if>
            <if test="year != null and year != ''">and belong_year=#{year}</if>
            <if test="quarter != null and quarter != ''">and cycle_desc=#{quarter}</if>
        </where>
    </select>

    <resultMap type="PersonalAssessResult" id="personalAssessResult">
        <result property="id" column="id"/>
        <result property="regularId" column="regular_id"/>
        <result property="userId" column="user_id"/>
        <result property="taskId" column="task_id"/>
        <result property="finalScore" column="final_score"/>
        <result property="finalOption" column="final_option"/>
        <result property="remark" column="remark"/>
        <result property="year" column="year"/>
        <result property="cycle" column="cycle"/>
        <result property="cycleDesc" column="cycle_desc"/>
        <result property="special" column="special"/>
        <result property="personnelType" column="personnel_type"/>
    </resultMap>
    <select id="selectPersonalAssessResult" resultMap="personalAssessResult">
        SELECT T.* FROM (
            SELECT
                r.id,
                ri.id as regular_id,
                t.user_id,
                r.task_id,
                r.final_score,
                r.final_option,
                r.remark,
                m.special,
                p.personnel_type,
                m.belong_year as year,
                m.assess_cycle as cycle,
                CASE m.assess_cycle
                WHEN '1' THEN m.task_moth
                WHEN '2' THEN m.task_quarter
                WHEN '3' THEN m.task_year
                ELSE '4' END as cycle_desc
            FROM
                biz_assess_overall_score_level_record AS r
                join biz_assess_task_manage m on m.task_id = r.task_id
                join biz_assess_indicator_pro p on p.pro_id = m.pro_id
                LEFT JOIN biz_assess_task_user_tag AS t on r.task_id = t.task_id and r.assessed_user_id = t.user_id
                left join biz_assess_regular_info ri on ri.user_tag_id = t.id
        ) as T
        <where>
            <if test="userId != null">and T.user_id = #{userId}</if>
            <if test="year != null and year != ''">and T.year = #{year}</if>
            <if test="cycleDesc != null and cycleDesc != ''">and T.cycle_desc = #{cycleDesc}</if>
            <if test="special != null and special != ''">and T.special = #{special}</if>
        </where>
    </select>
</mapper>